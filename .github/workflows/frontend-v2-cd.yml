name: FE V2 CD PIPELINE
run-name: FE V2 CD • ${{ github.event.workflow_run.head_sha }}

on:
  workflow_run:
    workflows: ["FE V2 CI PIPELINE"]
    types: [completed]

permissions:
  contents: read
  actions: read
  id-token: write

concurrency:
  group: fe-v2-cd-${{ github.event.workflow_run.head_sha }}
  cancel-in-progress: true

jobs:
  deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.event == 'push' }}
    runs-on: ubuntu-24.04-arm
    environment: ${{ github.event.workflow_run.head_branch == 'main' && 'production' || 'develop' }}
    env:
      AWS_REGION: ap-northeast-2

    steps:
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: dist-${{ github.event.workflow_run.head_sha }}
          path: dist
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ github.event.workflow_run.id }}

      - name: Verify build output
        run: test -d dist && test -f dist/index.html

      - name: Configure AWS Credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Deploy to S3
        env:
          S3_BUCKET: ${{ secrets.S3_BUCKET_NAME }}
        run: |
          # HTML — no-cache (항상 최신)
          aws s3 sync dist/ "s3://${S3_BUCKET}" \
            --delete \
            --cache-control "no-cache, no-store, must-revalidate" \
            --exclude "*" --include "*.html"

          # Assets (JS/CSS/이미지) — 장기 캐싱 (Vite content hash)
          aws s3 sync dist/ "s3://${S3_BUCKET}" \
            --delete \
            --cache-control "public, max-age=31536000, immutable" \
            --exclude "*.html"

      - name: Invalidate CloudFront cache
        env:
          CF_DISTRIBUTION_ID: ${{ secrets.CF_DISTRIBUTION_ID }}
        run: |
          INVALIDATION_ID=$(aws cloudfront create-invalidation \
            --distribution-id "${CF_DISTRIBUTION_ID}" \
            --paths "/*" \
            --query "Invalidation.Id" --output text)
          echo "Invalidation ID: ${INVALIDATION_ID}"
          echo "Waiting for invalidation to complete..."
          aws cloudfront wait invalidation-completed \
            --distribution-id "${CF_DISTRIBUTION_ID}" \
            --id "${INVALIDATION_ID}"
          echo "Invalidation completed"

      - name: Health check
        env:
          SITE_URL: ${{ github.event.workflow_run.head_branch == 'main' && 'https://moyeobab.com' || 'https://dev.moyeobab.com' }}
        run: |
          curl -sf --retry 5 --retry-delay 3 "${SITE_URL}" > /dev/null
          echo "Health check passed: ${SITE_URL}"

      - name: Notify Discord
        if: always()
        env:
          WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_CD }}
          BRANCH: ${{ github.event.workflow_run.head_branch }}
          COMMIT_MSG: ${{ github.event.workflow_run.head_commit.message }}
          AUTHOR: ${{ github.event.workflow_run.head_commit.author.name }}
          COMMIT_SHA: ${{ github.event.workflow_run.head_sha }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          ENV_UPPER=${{ github.event.workflow_run.head_branch == 'main' && 'PROD' || 'DEV' }}
          SHORT_SHA=$(echo "$COMMIT_SHA" | cut -c1-7)

          if [ "${{ job.status }}" = "success" ]; then
            TITLE="[${ENV_UPPER}] Frontend 배포 성공"
            DESC="S3 + CloudFront에 \`${SHORT_SHA}\` 배포 완료"
            COLOR=3066993
          elif [ "${{ job.status }}" = "cancelled" ]; then
            TITLE="[${ENV_UPPER}] Frontend 배포 취소"
            DESC="배포가 취소되었습니다"
            COLOR=9807270
          else
            TITLE="[${ENV_UPPER}] Frontend 배포 실패"
            DESC="배포 실패 — Actions 로그를 확인하세요"
            COLOR=15158332
          fi

          jq -n \
            --arg title "$TITLE" \
            --arg desc "$DESC" \
            --arg color "$COLOR" \
            --arg env_label "$ENV_UPPER" \
            --arg branch "$BRANCH" \
            --arg author "$AUTHOR" \
            --arg msg "$COMMIT_MSG" \
            --arg tag "sha-${SHORT_SHA}" \
            --arg url "$RUN_URL" \
            '{
              embeds: [{
                title: $title,
                description: $desc,
                color: ($color | tonumber),
                fields: [
                  {name: "환경", value: $env_label, inline: true},
                  {name: "브랜치", value: $branch, inline: true},
                  {name: "작성자", value: $author, inline: true},
                  {name: "버전", value: ("`" + $tag + "`"), inline: true},
                  {name: "커밋", value: $msg, inline: false},
                  {name: "상세", value: ("[Actions 로그](" + $url + ")"), inline: false}
                ],
                footer: {
                  text: "Frontend CD"
                }
              }]
            }' | curl -sf -X POST "$WEBHOOK" -H "Content-Type: application/json" -d @-
